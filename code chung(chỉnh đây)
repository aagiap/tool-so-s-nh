#!/bin/bash

# Hàm để giải nén file zip và đọc các file bên trong
extract_zip_files() {
    zip_file="$1"
    # Tạo thư mục tạm thời
    temp_dir=$(mktemp -d)
    # Giải nén file zip vào thư mục tạm thời
    unzip "$zip_file" -d "$temp_dir" > /dev/null
    # Lấy danh sách các file trong thư mục tạm thời
    files=$(find "$temp_dir" -type f)
    # Hiển thị danh sách các file
    echo "$files"
    # Xóa thư mục tạm thời sau khi hoàn thành
    rm -rf "$temp_dir"
}

# Hàm để kiểm tra loại file
check_file_type() {
    # Kiểm tra loại file bằng câu lệnh `file`
    file_type=$(file -b --mime-type "$1")

    # Nếu file là văn bản, trả về "text"
    if [[ $file_type == "text/plain" ]]; then
        echo "text"
    # Nếu file là hình ảnh, trả về "image"
    elif [[ $file_type == image/* ]]; then
        echo "image"
    # Nếu không, trả về MIME type của file
    else
        echo "$file_type"
    fi
}

# Hàm để so sánh MIME giữa hai file
compare_mime_files() {
    file1="$1"
    file2="$2"
    # Kiểm tra loại file của hai file
    type_file1=$(check_file_type "$file1")
    type_file2=$(check_file_type "$file2")
    
    # Thực hiện so sánh tùy thuộc vào loại file của hai file
    case "$type_file1-$type_file2" in
      "text-text")
        compare_text_files "$file1" "$file2"
        ;;
      "image-image")
        compare_image_files "$file1" "$file2"
        ;;
      "text-image")
        echo "0"  # Không cần so sánh văn bản với hình ảnh
        ;;
      "image-text")
        echo "0"  # Không cần so sánh hình ảnh với văn bản
        ;;
      *)
        echo "Không thể so sánh do loại file khác nhau."
        ;;
    esac
}

# Tạo giao diện người dùng với Zenity
while true; do
  CHOICE=$(zenity --list --title="So sánh MIME" --column="Options" "Chọn file ( .zip )" "Start")

  case "$CHOICE" in
    "Chọn file ( .zip )")
      # Cho phép người dùng chọn file zip
      zip_file=$(zenity --file-selection --title="Chọn file zip")
      ;;
    "Start")
      if [ -z "$zip_file" ]; then
        zenity --error --text="Vui lòng chọn tệp zip trước khi bắt đầu."
      else
        # Kiểm tra định dạng MIME của tệp zip
        mime_type=$(file -b --mime-type "$zip_file")
        if [ "$mime_type" != "application/zip" ]; then
          zenity --error --text="Tệp đã chọn không phải là tệp zip."
          continue
        fi

        # Thực hiện thao tác với tệp zip
        temp_dir=$(mktemp -d)
        unzip "$zip_file" -d "$temp_dir" > /dev/null
        file_list=($(ls "$temp_dir"))
        result=""
        for ((i=0; i<${#file_list[@]}; i++)); do
          for ((j=i+1; j<${#file_list[@]}; j++)); do
            file1="${file_list[$i]}"
            file2="${file_list[$j]}"
            
            # Kiểm tra xem tệp có tồn tại không
            if [ -e "$temp_dir/$file1" ] && [ -e "$temp_dir/$file2" ]; then
              total_lines_file1=$(wc -l < "$temp_dir/$file1")
              total_lines_file2=$(wc -l < "$temp_dir/$file2")
              diff_output=$(diff "$temp_dir/$file1" "$temp_dir/$file2")
              different_lines=$(echo "$diff_output" | grep "^<" | wc -l)
              line_difference=$(($total_lines_file1-$total_lines_file2))
              if [ $line_difference -lt 0 ]; then
                line_difference=$((-$line_difference))
              fi
              if [ $total_lines_file1 -lt $total_lines_file2 ]; then
                total_lines_file1=$((total_lines_file1+$line_difference))
              elif [ $total_lines_file2 -lt $total_lines_file1 ]; then
                total_lines_file2=$((total_lines_file2+$line_difference))
              fi
              similarity_percentage=$(bc <<< "scale=2; ((($total_lines_file1) - ($line_difference+$different_lines)) * 100) / ($total_lines_file1)")
              result+=" $file1 - $file2: $similarity_percentage%\\n"
            else
              # Nếu tệp không tồn tại, bỏ qua
              continue
            fi
          done
        done
        rm -rf "$temp_dir"
        zenity --info --text="$result"
        break
      fi
      ;;
    *)
      break
      ;;
  esac
done
